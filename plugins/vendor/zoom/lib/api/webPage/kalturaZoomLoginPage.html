<!DOCTYPE html>
<html>
<head>
    <title>Kaltura Zoom connector</title>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css'>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    <script>
        var authCode = '@authCode@';
    </script>
    <script>
        function onLoginSuccess(redirectUrl, res, zoomIntegrationId) {
            $.ajax({
                url: redirectUrl,
                type: 'post',
                data: {'ks': res, 'vendorIntegrationId':zoomIntegrationId},
                success: function (registrationPage)
                {
                    $('body').css('cursor', 'default');
                    if (registrationPage)
                    {
                        if(registrationPage.firstElementChild && registrationPage.firstElementChild.textContent.includes('KalturaAPIException'))
                        {
                            textFirstElement = new XMLSerializer().serializeToString(registrationPage.firstElementChild);
                            parser = new DOMParser();
                            xmlDoc = parser.parseFromString(textFirstElement, 'text/xml');
                            message = xmlDoc.getElementsByTagName('message')[0].childNodes[0].nodeValue;
                            onFail(message);
                        }
                        else
                        {
                            var newDoc = document.open('text/html', 'replace');
                            newDoc.write(registrationPage);
                            newDoc.close();
                        }

                    }
                },
                error: function () {
                    $('body').css('cursor', 'default');
                    console.log('err during api call');
                }
            });
        }

        function tryLogin(event)
        {
            $('body').css('cursor', 'progress');
            event.preventDefault();
            let integrationCode = $('#integrationCode');
            let kmcUrl = $('#kmcUrl');
            let regionStartIndex = 0;
            let regionEndIndex = kmcUrl.val().indexOf('kaltura.com');
            if (regionEndIndex < 0)
            {
                return onFail('Invalid URL');
            }
            regionEndIndex = regionEndIndex + 11;
            var regionUrl = kmcUrl.val().substring(regionStartIndex, regionEndIndex);
            var redirectUrlPage = '/api_v3/service/vendor_zoomvendor/action/fetchRegistrationPage';
            var redirectUrl = regionUrl.concat(redirectUrlPage);
            submitKMCUrl(regionUrl, redirectUrl, integrationCode);
        }

        function submitKMCUrl(regionUrl, redirectUrl, integrationCode)
        {
            $.ajax(
                {
                    url: regionUrl + '/api_v3/service/vendor_zoomvendor/action/oauthValidation',
                    type: 'post',
                    data: {'code': authCode},
                    success: function (res) {
                        $('body').css('cursor', 'default');
                        if(res)
                        {
                            if(res.firstElementChild)
                            {
                                textFirstElement = new XMLSerializer().serializeToString(res.firstElementChild);
                                parser = new DOMParser();
                                xmlDoc = parser.parseFromString(textFirstElement, 'text/xml');

                                if (res.firstElementChild.textContent.includes('KalturaAPIException'))
                                {
                                    message = xmlDoc.getElementsByTagName('message')[0].childNodes[0].nodeValue;
                                    onFail(message);
                                }
                                else
                                {
                                    zoomIntegrationId = xmlDoc.getElementsByTagName('result')[0].childNodes[0].nodeValue;
                                    onLoginSuccess(redirectUrl, integrationCode.val(), zoomIntegrationId);
                                }
                            }
                        }
                    },
                    error: function (err)
                    {
                        onFail(err);
                    }
            });
        }
        function onFail(errorMessage)
        {
            $('body').css('cursor', 'default');
            console.log('err during api call '+ errorMessage);
            alert('Error\n'+errorMessage);
        }
    </script>
    <script>
        (function() {
            document.addEventListener('DOMContentLoaded', function () {
                var submitButton = document.querySelector('#submit-button');
                submitButton.addEventListener('click', tryLogin);
            });
        })();
    </script>
    <title>Kaltura-Zoom login</title>
</head>
    <body>
    <div style='width: 500px;margin: auto; padding-top: 200px'>
        <form>
            <div class='form-group  container p-2 my-3 border'>
                <div class='imgcontainer'>
                    <img src='https://developer.kaltura.com/homepage/assets/images/Kaltura-logo.png' width='256' class='mx-auto d-block'>
                </div>
                <div class='container'>
                    <div class='form-group'>
                        <label><h6>Integration code</h6></label>
                        <input type='text' placeholder='Enter Integration Code' id='integrationCode' class='form-control' name='integrationCode' required>
                    </div>
                    <div class='form-group'>
                        <label><h6>Please submit the URL of your KMC</h6></label>
                        <input type='text' placeholder='http://...' id='kmcUrl' class='form-control' name='kmcUrl' required>
                    </div>
                    <button type='submit' id='submit-button' class='btn btn-primary'>Login</button>
                </div>
            </div>
    </form>
    </div>
</body>
</html>
