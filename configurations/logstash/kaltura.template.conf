input {

	file {
		path => "@LOG_DIR@/kaltura_api_v3.log"
		type => "api_v3"
		add_field => { "format" => "kalturaServer" }
	}
	
	file {
		path => "@LOG_DIR@/kaltura_prod.log"
		type => "core"
		add_field => { "format" => "kalturaServer" }
	}

	file {
		path => "@LOG_DIR@/batch/capturethumb-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/capturethumb-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/concat-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/concat-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/convert-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/convert-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/convertcloser-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/convertcloser-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/convertlivesegment-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/convertlivesegment-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/convertprofilecloser-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/convertprofilecloser-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/copy-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/copy-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/delete-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/delete-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/deletefile-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/deletefile-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/dispatcheventnotification-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/dispatcheventnotification-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/distributedelete-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/distributedelete-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/distributedeletecloser-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/distributedeletecloser-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/distributesubmit-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/distributesubmit-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/distributesubmitcloser-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/distributesubmitcloser-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/distributeupdate-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/distributeupdate-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/distributeupdatecloser-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/distributeupdatecloser-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/extractmedia-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/extractmedia-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/import-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/import-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/mailer-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/mailer-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/notifier-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/notifier-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/parsecaptionasset-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/parsecaptionasset-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/postconvert-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/postconvert-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/provisiondelete-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/provisiondelete-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/provisionprovide-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/provisionprovide-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/provisionprovidecloser-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/provisionprovidecloser-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/storagedelete-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/storagedelete-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/storageexport-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/storageexport-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/storageexportcloser-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/storageexportcloser-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/transformmetadata-*.err.log"
		type => "error"
		add_field => { "format" => "kalturaClient" }
	}
	file {
		path => "@LOG_DIR@/batch/transformmetadata-*.log"
		type => "batch"
		add_field => { "format" => "kalturaClient" }
	}

	file {
		path => "@LOG_DIR@/kaltura_admin.log"
		type => "admin"
		add_field => {
			"format" => "kalturaClient"
			"title" => "Admin-Console" 
		}
	}
	
	file {
		path => "@LOG_DIR@/kaltura_multi_publishers.log"
		type => "var"
		add_field => {
			"format" => "kalturaClient"
			"title" => "Multi-Publishers-Console" 
		}
	}
	
	file {
		path => "@LOG_DIR@/kaltura_apache_access.log"
		type => "access"
		add_field => { "title" => "Apache Access" } 
	}
	file {
		path => "@LOG_DIR@/kaltura_apache_error.log"
		type => "error"
		add_field => { "title" => "Apache Error" }
	}
}

filter {
	
	if [type] == "access" {
		grok {
#			match => ["message", "%{IPORHOST:clientip} %{USER:ident} %{USER:auth} \[%{HTTPDATE:timestamp}\] \"%{WORD:method} %{NOTSPACE:request} HTTP/%{NUMBER:httpversion}\" %{NUMBER:status} %{NUMBER:bytes} %{NUMBER:seconds}/%{NUMBER:microseconds} \"(?<referrer>[^\"]+)\" \"(?<userAgent>[^\"]+)\" \"(?<f5Https>[^\"]+)\" %{NOTSPACE:f5RemoteAddress} \"(?<xKaltura>[^\"]+)\" \"(?<hostname>[^\"]+)\" %{NUMBER:processId} %{NUMBER:sessionId} (?<connectionStatus>[X+-]) %{NUMBER:bytesReceived} \"(?<contentRange>[^\"]+)\" \"(?<xForwardedFor>[^\"]+)\" \"(?<xForwardedServer>[^\"]+)\" \"(?<xForwardedHost>[^\"]+)\" \"(?<cacheControl>[^\"]+)\" %{NUMBER:partnerId} %{IPORHOST:f5ExtIp} %{NOTSPACE:f5ExtHops}"]
			match => ["message", "%{IPORHOST:clientip} %{USER:ident} %{USER:auth} \[%{HTTPDATE:timestamp}\] \"%{WORD:method} %{NOTSPACE:request} HTTP/%{NUMBER:httpversion}\" %{NUMBER:status} %{NUMBER:bytes} %{NUMBER:seconds}/%{NUMBER:microseconds} \"(?<referrer>[^\"]+)\" \"(?<userAgent>[^\"]+)\" \"(?<uv>[^\"]+)\" %{IPORHOST:remoteip} \"(?<xKaltura>[^\"]+)\" \"(?<hostname>[^\"]+)\" %{NUMBER:processId} %{NUMBER:sessionId} (?<connectionStatus>[X+-]) %{NUMBER:bytesReceived} \"(?<contentRange>[^\"]+)\" \"(?<xForwardedFor>[^\"]+)\" \"(?<xForwardedServer>[^\"]+)\" \"(?<xForwardedHost>[^\"]+)\" \"(?<cacheControl>[^\"]+)\" %{NUMBER:partnerId}"]
			tag_on_failure => "wrong_format"
		}
	}
	
	if [type] == "error" {
		grok {
			match => ["message", "\[%{HTTPDATE:timestamp}\] \[%{WORD:level}\] \[client %{IPORHOST:clientip}\]"]
			tag_on_failure => "wrong_format"
		}
	}
	
	if [format] == "kalturaServer" {
		multiline {
			pattern => "^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}"
			negate => true
			what => "previous"
		}
		grok {
			match => ["message", "^(?<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[%{NUMBER:duration}\] \[%{IP:ip}\] \[%{NUMBER:sessionId}\] \[%{NUMBER:sessionIndex}\] \[%{WORD:context}\] \[(?<method>[^\]]+)\] %{WORD:level}:"]
			tag_on_failure => "wrong_format"
		}
		mutate {
			convert => [ "sessionIndex", "integer" ]
		}
		date {
			match => [ "timestamp" , "yyyy-MM-dd HH:mm:ss" ]
			timezone => "@TIME_ZONE@"
		}
		grok {
			match => ["message", "Event \[%{WORD:eventType}\] object type \[%{WORD:objectType}\] id \[%{WORD:objectId}\]"]
			add_tag => [ "event" ]
		}
		grok {
			match => ["message", "Event \[%{WORD:eventType}\] job id \[%{NUMBER:jobId}\] type \[%{NUMBER:jobType}\] sub type \[%{NUMBER:jobSubType}\] status \[%{NUMBER:jobStatus}\]"]
			add_tag => [ "event" ]
		}
		grok {
			match => ["message", "consumer \[%{WORD:consumer}\] started handling \[%{WORD:objectType}\]"]
			add_tag => [ "consumerStart", "event" ]
		}
		grok {
			match => ["message", "consumer \[%{WORD:consumer}\] finished handling \[%{WORD:objectType}\]"]
			add_tag => [ "consumerEnd", "event" ]
		}
		if [eventType] == "kBatchJobStatusEvent" {
			mutate {
				add_field => { "objectType" => "BatchJob" }
			}
		}
	}
	
	if [type] == "core" {
		grok {
			match => ["message", "\{sfRequest\} request parameters array \(  'module' => '%{WORD:service}',  'action' => '%{WORD:action}',"]
			add_field => { "title" => "PS2: %{service}.%{action}" }
		}
	}
	
	if [type] == "api_v3" {
		grok {
			match => ["message", "Dispatching service \[%{WORD:service}\], action \[%{WORD:action}\]"]
			add_field => { "title" => "API V3: %{service}.%{action}" }
		}
		if [message] =~ ">------------------------------------- api_v3 --" {
			mutate {
				add_tag => [ "start", "event" ]
			}
		}
		else if [message] =~ "<------------------------------------- api_v3 --" {
			mutate {
				add_tag => [ "end", "event" ]
			}
		}
		if [pos] && !("event" in [tags]) {
			drop { }
		}
	}
	
	if [format] == "kalturaClient" {
		multiline {
			pattern => "^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}"
			negate => true
			what => "previous"
		}
		grok {
			match => ["message", "^(?<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[%{NUMBER:duration}\] \[%{NUMBER:sessionId}\] \[%{NUMBER:sessionIndex}\] \[(?<context>[^\]]+)\] \[(?<method>[^\]]+)\] %{WORD:level}:"]
			tag_on_failure => "wrong_format"
		}
		mutate {
			convert => [ "sessionIndex", "integer" ]
		}
		date {
			match => [ "timestamp" , "yyyy-MM-dd HH:mm:ss" ]
			timezone => "@TIME_ZONE@"
		}
		grok {
			match => ["message", "\/api_v3\/index\.php\?service=(?<apiService>[^&]+)&action=(?<apiAction>[^&]+)"]
			add_tag => [ "api_call" ]
		}
		grok {
			match => ["message", "server: \[(?<apiServer>[^\]]+)\], session: \[%{WORD:apiSession}\]"]
			add_tag => [ "api_session" ]
		}	
	}
	
	if [type] == "batch" {
		grok {
			match => ["path", "[\\\/]%{WORD:worker}-(?<batchIndex>[\d]+)-"]
			tag_on_failure => "wrong_path"
			add_field => { "title" => "Batch: %{worker}[%{batchIndex}]" }
		}
		if [message] =~ "___________________________________________________________________________________" {
			mutate {
				add_tag => "start"
			}
		}
		grok {
			match => ["message", "Done after \[%{NUMBER:sessionDuration}\] seconds"]
			add_tag => [ "end" ]
		}
		grok {
			match => ["message", "Start job\[%{NUMBER:jobId}\] type\[%{WORD:jobType}\] sub-type\[%{WORD:jobSubType}\] object\[%{WORD:objectType}\] object-id\[%{WORD:objectId}\] partner-id\[%{NUMBER:partnerId}\] dc\[%{NUMBER:dc}\] parent-id\[%{NUMBER:parentJobId}\] root-id\[%{NUMBER:rootJobId}\]"]
			add_tag => [ "jobStart" ]
		}
		grok {
			match => ["message", "End job\[%{NUMBER:jobId}\]"]
			add_tag => [ "jobEnd" ]
		}
	}
}

output {
	elasticsearch { host => @ELASTIC_SEARCH_HOST@ }
	# stdout { codec => rubydebug }
}
